<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="boardMapper">
	<!-- 글 작성 -->
	<insert id="insertBoard" parameterType="boardVO">
		insert into board (title, content, isanony, userid, date) values (#{title}, #{content}, #{isanony}, #{userid}, DATE_FORMAT(now(), '%Y-%m-%d %H:%i:%s'));
		<selectKey keyProperty="bno" resultType="int" order="AFTER">
			select MAX(bno) from board;
		</selectKey>
	</insert>
	
	<!-- 첨부파일 작성 -->
	<insert id="insertFile" parameterType="fileVO">
		insert into boardfile values (#{uuid}, #{uploadpath}, #{filename}, #{bno});
	</insert>
	
	<!-- 게시물 목록 -->
	<select id="selectBoard" parameterType="pageVO" resultType="boardVO">
		select * from (select row_number() over(order by bno desc) as rownum, board.* from board) as board2 where board2.rownum between #{startBoard} and #{endBoard}; 
	</select>
	
	<!-- 게시물 수 -->
	<select id="countBoard" resultType="int">
		select count(*) from board;
	</select>
	
	<!-- 게시물 내용 -->
	<select id="boardInfo" parameterType="int" resultType="boardVO">
		select * from board where bno = #{bno};
	</select>
	
	<!-- 게시물 첨부파일 가져오기 -->
	<select id="fileInfo" parameterType="int" resultType="fileVO">
		select * from boardfile where bno = #{bno};
	</select>
	
	<!-- 게시물 삭제 -->
	<delete id="deleteBoard" parameterType="int">
		delete from board where bno = #{bno};
	</delete>
	
	<!-- 댓글 등록 -->
	<insert id="insertReply" parameterType="replyVO">
		insert into reply values (#{rno}, #{content}, #{userid}, #{isanony}, #{bno}, DATE_FORMAT(now(), '%Y-%m-%d %H:%i:%s'));
	</insert>
	
	<!-- 댓글 삭제 -->
	<delete id="deleteReply" parameterType="int">
		delete from reply where rno = #{rno};
	</delete>
	
	<!-- 댓글 보여주기 -->
	<select id="selectReply" parameterType="int" resultType="replyVO">
		select * from reply where bno = #{bno};
	</select>
	
	<!--게시물 수정 -->
	<update id="updateBoard" parameterType="boardVO">
		update board set title = #{title}, content = #{content}, isanony = #{isanony} where bno = #{bno};
	</update>
	
	<!--첨부파일 삭제 -->
	<delete id="deleteFile" parameterType="int">
		delete from boardfile where bno = #{bno};
	</delete>
	
	<!-- 게시글 검색 -->
	<select id="searchBoard" parameterType="Map" resultType="boardVO">
		select * from (select row_number() over(order by bno desc) as rownum, board.* from board where title like concat('%', #{search}, '%') or content like concat('%', #{search}, '%')) as board2 where board2.rownum between #{startBoard} and #{endBoard};
	</select>
	
	<!-- 게시글 검색 내역 개수 -->
	<select id="countSearch" parameterType="String" resultType="int">
		select count(*) from board where title like concat('%', #{search}, '%') or content like concat('%', #{search}, '%');
	</select>
</mapper>